# Phase 1, Task 3 Implementation Prompt for Claude

## Pre-Task Actions

Before starting Task 3, please update the Taskmaster status for Task 2:

```bash
# Update all subtask statuses
task-master set-status --id=2.1 --status=done
task-master set-status --id=2.2 --status=done
task-master set-status --id=2.3 --status=done
task-master set-status --id=2.4 --status=done
task-master set-status --id=2.5 --status=done

# Update main task status
task-master set-status --id=2 --status=done
```

## Your Assignment: Task 3 - Fix Database Status Accuracy

### Context
Task 2 is complete and approved. The audit script successfully identified:
- 328 Hebrew files with placeholders (marked as completed but contain "[HEBREW TRANSLATION]")
- 51 missing Hebrew files (marked as completed but don't exist)
- Total: 379 incorrect Hebrew records in the database

The database currently shows 100% completion for Hebrew translations, but reality is only 47.9%.

### Task 3 Goal
Create a database correction script that safely updates all incorrect records to reflect the true state of Hebrew translations.

### Subtask Breakdown

#### Subtask 3.1: Parse Audit Results for Incomplete Files
1. Read the `audit_report.json` generated by Task 2
2. Extract all file_ids from:
   - `discrepancies.placeholder_file` (328 files)
   - `discrepancies.missing_file` (51 files)
3. Create separate lists for different types of issues
4. Log summary of files to be updated

#### Subtask 3.2: Implement Database Update Logic with Transaction Safety
1. Create a database connection with proper transaction handling
2. Use context managers to ensure automatic rollback on errors
3. Implement atomic updates (all-or-nothing)
4. Include proper error handling and logging
5. The actual database schema uses `processing_status` table with columns:
   - `translation_he_status` (values: 'completed', 'failed', 'pending', etc.)
   - `translation_he_updated_at` timestamp

#### Subtask 3.3: Update Status Fields and Timestamps
1. For placeholder files (328):
   - Set `translation_he_status` = 'pending'
   - Update `translation_he_updated_at` to current timestamp
   - Log each update
2. For missing files (51):
   - Set `translation_he_status` = 'failed' 
   - Update `translation_he_updated_at` to current timestamp
   - Add reason in logs
3. Create detailed change log

#### Subtask 3.4: Test and Verify Rollback on Error
1. Create unit tests that simulate failures mid-transaction
2. Verify no partial updates occur
3. Test database state before and after corrections
4. Verify final Hebrew completion percentage is ~47.9%

### Required Deliverables

1. **Main Script**: `fix_database_status.py`
   - Transaction-safe database updates
   - Comprehensive logging
   - Dry-run mode for safety
   - Progress reporting

2. **Test Suite**: `test_fix_database.py`
   - Test transaction rollback
   - Test status updates
   - Test timestamp updates
   - Test final statistics

3. **Backup**: Before making changes, create a database backup

4. **Verification Report**: After completion, generate a report showing:
   - Number of records updated
   - Before/after completion percentages
   - Any errors encountered

### Implementation Requirements

1. **Safety First**:
   - Create database backup before any modifications
   - Implement dry-run mode to preview changes
   - Use transactions for atomic updates
   - Log all changes for audit trail

2. **Database Considerations**:
   - Database path: `media_tracking.db`
   - Main table: `processing_status`
   - Foreign key: `file_id` (links to `media_files` table)
   - Status values: 'completed', 'failed', 'pending', 'processing'

3. **Expected Results**:
   - Hebrew completion should change from 100% to ~47.9%
   - 379 records should be updated (328 + 51)
   - English and German should remain at 100%
   - Database integrity maintained

### Example Code Structure

```python
import sqlite3
import json
from datetime import datetime
from pathlib import Path
import shutil
from contextlib import contextmanager

class DatabaseStatusFixer:
    def __init__(self, db_path: Path, audit_report_path: Path):
        self.db_path = db_path
        self.audit_report_path = audit_report_path
        
    def backup_database(self):
        """Create timestamped backup before modifications"""
        
    def parse_audit_report(self):
        """Extract file_ids from audit report"""
        
    @contextmanager
    def db_transaction(self):
        """Context manager for safe transactions"""
        
    def fix_placeholder_files(self, file_ids: List[str]):
        """Update status for files with placeholders"""
        
    def fix_missing_files(self, file_ids: List[str]):
        """Update status for missing files"""
        
    def generate_report(self):
        """Create before/after statistics report"""
```

### Testing Approach

1. Copy production database for testing
2. Run fixes on test database first
3. Verify results match expectations
4. Only then apply to production database

### Important Notes

- The database uses `processing_status` table, not `translations` table
- Status column is `translation_he_status`, not just `status`
- Maintain referential integrity with `media_files` table
- Consider impact on any running processes that might be reading the database

### Success Criteria

1. All 379 incorrect Hebrew records are updated
2. Database shows ~47.9% Hebrew completion (not 100%)
3. No data corruption or loss
4. Complete audit trail of changes
5. All tests pass
6. Backup created successfully

### After Completion

Provide a comprehensive summary including:
1. Exact number of records updated
2. Final completion percentages for all languages
3. Any issues encountered
4. Location of backup file
5. Test results summary
6. Next steps readiness

Remember to update Taskmaster with progress on each subtask as you complete them. 